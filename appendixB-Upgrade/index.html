<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Appendix B - Upgrade - Cisco Live 2021 HOLDCN-1010</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Appendix B - Upgrade";
    var mkdocs_page_input_path = "appendixB-Upgrade.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Cisco Live 2021 HOLDCN-1010</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../intro/">Introduction</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../Task1-ansible-node/">Task 1 - Prepare Ansible node</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../task2-first-ansible/">Task 2 - First Simple Ansible Playbook</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../task3-vxlan-jinja2/">Task 3 - Use of Jinja2 templates with Ansible Playbook</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../task4-vxlan-nxos/">Task 4 - Config switches using Ansible NXOS modules</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../task5-day2-operation/">Task 5 - Day 2 Operations</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../appendixA-F5/">Appendix A - F5</a>
                    </li>
                </ul>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Appendix B - Upgrade</a>
    <ul class="current">
    </ul>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Cisco Live 2021 HOLDCN-1010</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Appendix B - Upgrade</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/fchaudhr/holdcn-1010.git/edit/master/docs/appendixB-Upgrade.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>

          <div role="main">
            <div class="section">
              
                <h1 id="appendix-b-software-compliance-check-and-remediation">Appendix B: Software compliance check and remediation</h1>
<p>In this section, we will run software version compliance check using Ansible. For fabric switch that is not running on standard software version, we will perform software upgrade and bring all fabric switches into the standard version.  </p>
<p>In this playbook, we will use “nxos_facts” to find the software version on each fabric switch. Then we will compare with standard software version, 7.0(3)I7(4) in this lab. For fabric switch that is not running on standard version, the playbook will upgrade and reboot the switch. </p>
<p>The playbook will use <strong>“nxos_file_copy”</strong> module to copy image from remote repository to bootflash. A bug fix is introduced in Ansible 2.9 and upward to avoid timeout issue when coping large file, so fist we will upgrade ansible to 2.9.1</p>
<ul>
<li>On Ansible server execute command <code>pip install ansible==2.9.1</code> to upgrade Ansible to 2.9.1 release:</li>
</ul>
<pre><code>[root@rhel7-tools LTRDCN-1572]# pip install ansible==2.9.1
</code></pre>
<ul>
<li>On <strong>Atom,</strong> open up the project folder <code>LTRDCN-1572</code> and create new file under this folder (“LTRDCN-1572”). Name the new file <strong>“code_upgrade.yml”.</strong> and add below content (you may copy and paste):</li>
</ul>
<pre><code class="language-yaml">---
#Appendix code upgrade
  - hosts: spine,leaf
    vars:
      - standard: 7.0(3)I7(4)
      - image_file: nxos.7.0.3.I7.4.bin
      - ansible_connection: network_cli
      - ansible_network_os: nxos
      - ansible_user: &quot;{{ user }}&quot;
      - ansible_password: &quot;{{ pwd }}&quot;
      - ansible_connect_timeout: 120
    tasks:
      - name: &quot;software complaince check&quot;
        nxos_facts:
          gather_subset: all
      - name: &quot;change to standard code&quot;
        block:
          - debug: msg=&quot;{{ansible_net_hostname}} is not running standard {{standard}}&quot;
          - nxos_feature:
              feature: scp-server
              state: enabled
          - name: &quot;upload image file&quot;
            nxos_file_copy:
              file_pull: True
              file_pull_timeout: 1200
              remote_file: &quot;/home/admin/downloads/{{image_file}}&quot;
              remote_scp_server: &quot;198.18.4.150&quot;
              remote_scp_server_user: &quot;root&quot;
              remote_scp_server_password: &quot;C1sco12345&quot;
          - name: &quot;change boot statement&quot;
            nxos_config:
              lines: boot nxos bootflash:{{image_file}}
              save_when: modified
          - name: &quot;reload switch&quot;
            ios_command:
              commands:
                - command: reload
                  prompt: '(y/n)?'
                  answer: 'y'
              username: &quot;{{ user }}&quot;
              password: &quot;{{ pwd }}&quot;
        when: ansible_net_version != standard
        rescue:
          - debug:
              msg: &quot;{{ansible_net_hostname}} is reloading&quot;
          - name: Wait For Device To Come Back Up
            wait_for:
              port: 22
              state: started
              timeout: 900
              delay: 60
              host: &quot;{{ inventory_hostname }}&quot;
        always:
          - debug:
              msg: &quot;All devices are running {{standard}}&quot;

</code></pre>
<ul>
<li>On the Ansible server, run the playbook for software compliance check and code upgrade by issuing the <code>ansible-playbook code_upgrade.yml</code> command as shown below: </li>
</ul>
<pre><code>[root@rhel7-tools LTRDCN-1572]# ansible-playbook code_upgrade.yml
</code></pre>
<hr />
<p><font style= "background-color:  yellow"><strong>Note:</strong> It is expected to see timeout error message when playbook reloads the switch.</font></p>
<hr />
<p>Below screenshot shows the output of above command:</p>
<p><img alt="" src="../pic/b2_1_0.png" /></p>
<hr />
<p><font style= "background-color:  yellow">Switch will take 20 mins to bootup; up to this point, you have completed all tasks.* </font></p>
<hr />
<h1 id="congratulations-you-have-completed-the-whole-lab-including-the-optional-appendix-sections-well-done">Congratulations! You have completed the whole lab including the Optional (Appendix) sections. Well done!</h1>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="../appendixA-F5/" class="btn btn-neutral" title="Appendix A - F5"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/fchaudhr/holdcn-1010.git/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../appendixA-F5/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
