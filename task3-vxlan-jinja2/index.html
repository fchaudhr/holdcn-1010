
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-7.3.6">
    
    
      
        <title>Task 3 - Use of Jinja2 templates with Ansible Playbook - Cisco Live 2021 HOLDCN-1010</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.a57b2b03.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#step-1-install-jinja2" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Cisco Live 2021 HOLDCN-1010" class="md-header__button md-logo" aria-label="Cisco Live 2021 HOLDCN-1010" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Cisco Live 2021 HOLDCN-1010
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Task 3 - Use of Jinja2 templates with Ansible Playbook
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://fchaudhr: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@github.com/fchaudhr/holdcn-1010.git" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Fchaudhr:Ghp_Pyfgnyv7Vyvcmpehrd9Imbshzpavop31W8Rk@Github
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Cisco Live 2021 HOLDCN-1010" class="md-nav__button md-logo" aria-label="Cisco Live 2021 HOLDCN-1010" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Cisco Live 2021 HOLDCN-1010
  </label>
  
    <div class="md-nav__source">
      
<a href="https://fchaudhr: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@github.com/fchaudhr/holdcn-1010.git" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Fchaudhr:Ghp_Pyfgnyv7Vyvcmpehrd9Imbshzpavop31W8Rk@Github
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../intro/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Task1-ansible-node/" class="md-nav__link">
        Task 1 - Prepare Ansible node
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../task2-first-ansible/" class="md-nav__link">
        Task 2 - First Simple Ansible Playbook
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Task 3 - Use of Jinja2 templates with Ansible Playbook
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Task 3 - Use of Jinja2 templates with Ansible Playbook
      </a>
      
        


<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#step-1-install-jinja2" class="md-nav__link">
    Step 1: Install jinja2
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-playbook-for-jinja2-spine" class="md-nav__link">
    Step 2: Playbook for jinja2 Spine
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-3-create-new-roles-and-vars" class="md-nav__link">
    Step 3: Create new roles and vars
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-4-create-variable-file-for-jina2_spine-role" class="md-nav__link">
    Step 4: Create variable file for “jina2_spine” role
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-5-create-jinja2-template-for-spine-role" class="md-nav__link">
    Step 5: Create Jinja2 template for spine role
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-6-create-playbook-for-jinja2_spine-role" class="md-nav__link">
    Step 6: Create playbook for jinja2_spine role
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-7-run-jinja2_fabric-playbook" class="md-nav__link">
    Step 7: Run Jinja2_fabric playbook
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-8-modify-playbook-for-leaf" class="md-nav__link">
    Step 8: Modify playbook for Leaf
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-9-variable-file-for-jinja2_leaf-role" class="md-nav__link">
    Step 9: Variable file for jinja2_leaf role
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-10-jinja2-template-for-leaf-role" class="md-nav__link">
    Step 10: Jinja2 template for leaf role
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-11-create-playbook-for-jinja2_leaf-role" class="md-nav__link">
    Step 11: Create playbook for jinja2_leaf role
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-12-run-jinja2_fabric-playbook" class="md-nav__link">
    Step 12: Run Jinja2_fabric playbook
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../task4-vxlan-nxos/" class="md-nav__link">
        Task 4 - Config switches using Ansible NXOS modules
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../task5-day2-operation/" class="md-nav__link">
        Task 5 - Day 2 Operations
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../appendixA-F5/" class="md-nav__link">
        Appendix A - F5
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../appendixB-Upgrade/" class="md-nav__link">
        Appendix B - Upgrade
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#step-1-install-jinja2" class="md-nav__link">
    Step 1: Install jinja2
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-playbook-for-jinja2-spine" class="md-nav__link">
    Step 2: Playbook for jinja2 Spine
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-3-create-new-roles-and-vars" class="md-nav__link">
    Step 3: Create new roles and vars
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-4-create-variable-file-for-jina2_spine-role" class="md-nav__link">
    Step 4: Create variable file for “jina2_spine” role
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-5-create-jinja2-template-for-spine-role" class="md-nav__link">
    Step 5: Create Jinja2 template for spine role
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-6-create-playbook-for-jinja2_spine-role" class="md-nav__link">
    Step 6: Create playbook for jinja2_spine role
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-7-run-jinja2_fabric-playbook" class="md-nav__link">
    Step 7: Run Jinja2_fabric playbook
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-8-modify-playbook-for-leaf" class="md-nav__link">
    Step 8: Modify playbook for Leaf
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-9-variable-file-for-jinja2_leaf-role" class="md-nav__link">
    Step 9: Variable file for jinja2_leaf role
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-10-jinja2-template-for-leaf-role" class="md-nav__link">
    Step 10: Jinja2 template for leaf role
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-11-create-playbook-for-jinja2_leaf-role" class="md-nav__link">
    Step 11: Create playbook for jinja2_leaf role
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-12-run-jinja2_fabric-playbook" class="md-nav__link">
    Step 12: Run Jinja2_fabric playbook
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>Task 3 - Use of Jinja2 templates with Ansible Playbook</h1>
                
                <p>In this task, we are going to install Jinja2 - that provides templating option.  In this section, we use Jinja2 to create template for spine and leaf and configure VXLAN fabric using this Jinja2 templates. </p>
<p><img alt="" src="../pic/3-0-1-new.png" /></p>
<p>Jinja2 template looks just like the NXOS configurations. We abstract the variables out of the configuration and use simple for loop to feed variables into the template. </p>
<hr />
<h3 id="step-1-install-jinja2">Step 1: Install jinja2</h3>
<ul>
<li>On the Ansible node, install jinja2 using <code>pip install jinja2</code> command.  If it is already installed, we will get the message “requirement is satisfied”:</li>
</ul>
<pre><code>        [root@rhel7-tools ~]# pip install jinja2
</code></pre>
<p>Below screenshot shows the output of above command:</p>
<p><img alt="" src="../pic/3-1-1-new.png" /></p>
<hr />
<h3 id="step-2-playbook-for-jinja2-spine">Step 2: Playbook for jinja2 Spine</h3>
<p>In this section, we will use Jina2 template and Ansible to provision the VXLAN Fabric. </p>
<ul>
<li>
<p>Switch to “Atom”, <strong>right click</strong> on the folder <code>LTRDCN-1572</code> and Click <code>New File</code> to create a new playbook named <code>jinja2_fabric.yml</code>. </p>
<p><img alt="" src="../pic/3-2-1.png" /></p>
</li>
<li>
<p>Name the new file <code>jinja2_fabric.yml</code> and hit enter as shown below. It will create this new file:</p>
</li>
</ul>
<p><img alt="" src="../pic/3-2-1a.png" /></p>
<ul>
<li>
<p>Also, on the lower bar of the ATOM, verify that  file grammar of <strong>YAML</strong> is selected instead of default "<strong>Plain Text</strong>".  If <strong>YAML</strong> is not selected, then you should <strong>choose</strong> it from the listed options.</p>
</li>
<li>
<p>Now enter below data in this playbook:</p>
</li>
</ul>
<pre><code class="language-YAML">---
  - hosts: jinja2_spine
    connection: local
    roles:
    - jinja2_spine

</code></pre>
<ul>
<li>
<p>The contents of the <strong>jinja2_fabric.yml</strong> file should look like</p>
<p><img alt="" src="../pic/3-2-2-new.png" /></p>
</li>
<li>
<p><strong>Click</strong> <code>File</code> and <code>Save</code> . This will save the playbook, and also ftp the playbook to Ansible server using pre-configured “<strong>remote-sync</strong>” package</p>
</li>
<li>
<p>On the MTputty, go back to the <strong>ssh</strong> session to Ansible Server node (198.18.134.150). </p>
</li>
<li>
<p>On Ansible server node (198.18.134.150), <strong>verify</strong> that the (below highlighted) 2 groups exists of <em>jinja2_spine</em> and <em>jinja2_leaf</em> in the inventory file named "<strong>hosts</strong>" (under LTRDCN-1572 directory) exists by issuing below commands:</p>
</li>
</ul>
<pre><code>[root@rhel7-tools ~]# cd /root/LTRDCN-1572
[root@rhel7-tools ~]# more hosts
</code></pre>
<p>Below screenshot confirms the ouptut and appropriate IP addresses of above command:</p>
<p><img alt="" src="../pic/3-2-3.png" /></p>
<hr />
<h3 id="step-3-create-new-roles-and-vars">Step 3: Create new roles and vars</h3>
<p>In this section, we will create two new roles for provisioning Fabric with Jina2 template.</p>
<ul>
<li>
<p>On the MTputty, go back to Ansible Server node (198.18.134.150), switch to ‘<strong>roles</strong>’ directory; <strong>create</strong> ‘jinja2_spine’ and ‘jinja2_leaf’ roles using ansible-galaxy using below commands: </p>
<pre><code>[root@rhel7-tools ~]# cd ~/LTRDCN-1572/
[root@rhel7-tools LTRDCN-1572]# cd roles/
[root@rhel7-tools roles]# ansible-galaxy init jinja2_spine&amp;&amp;ansible-galaxy init jinja2_leaf
</code></pre>
</li>
<li>
<p>Below screenshot shows the output of above command:</p>
</li>
</ul>
<p><img alt="" src="../pic/3-3-1.png" /></p>
<p><em>Note:</em> ‘<strong>ansible-galaxy</strong>’ will initialize the role structure and create necessary folders with default name like ‘tasks’, ‘template’, ‘vars’ etc.</p>
<ul>
<li>
<p><strong>change directory</strong> path to LTRDCN-1572/roles/jinja2_spine and check the content of local directory (<code>ls</code>) as per below commands:</p>
<pre><code>[root@rhel7-tools]# cd ~/LTRDCN-1572/roles/jinja2_spine/
[root@rhel7-tools jinja2_spine]# ls
</code></pre>
</li>
<li>
<p>Below screenshot shows the output of above file.  Note that various directories including tasks, templates, vars exists.  We will use these in later steps. </p>
<p><img alt="" src="../pic/3-3-2.png" /></p>
</li>
</ul>
<p>Next:</p>
<ul>
<li>
<p><strong>Create</strong> empty jinja2 template files for spine and leaf under templates folder for each role by running below commands:</p>
<pre><code>[root@rhel7-tools roles]# cd ~/LTRDCN-1572/roles
[root@rhel7-tools roles]# touch jinja2_spine/templates/spine.j2
[root@rhel7-tools roles]# touch jinja2_leaf/templates/leaf.j2
</code></pre>
</li>
<li>
<p>Switch to “<strong>Atom</strong>” and sync the new created folders between Ansible node and Remote desktop by pressing <strong>Right Click</strong> on the folder <code>LTRDDCN-1572</code>, then open <code>Remote Sync</code> select <code>Download Folder</code> as shown below:</p>
</li>
</ul>
<p><img alt="" src="../pic/3-3-3.png" /></p>
<ul>
<li>Once the download is done you should see the new folder &amp; files (<code>roles</code>) appear on ATOM as well.</li>
</ul>
<hr />
<h3 id="step-4-create-variable-file-for-jina2_spine-role">Step 4: Create variable file for “jina2_spine” role</h3>
<p>“<strong>ansible-galaxy</strong>” automatically creates empty “<strong>main.yml</strong>” file under “<strong>vars</strong>” folder. We can use “<strong>Atom</strong>” to edit the main.yml file to include the following variables that will be used in jinja2 template. </p>
<ul>
<li>
<p>Switch to <strong>ATOM</strong>, then open up the project folder <code>LTRDCN-1572</code> from the left pane and <strong>open</strong> <code>main.yml</code> file under “<strong>roles/jinja2_spine/vars/</strong>” as shown below:</p>
<p><img alt="" src="../pic/3-4-1.png" /></p>
</li>
<li>
<p>use “<strong>Atom</strong>” to edit the “<strong>main.yml</strong>” file to include the following variables that will be used in jinja2 template.  You can copy and paste all of the below content into main.yml file.  Note: as per steps in previous tasks, be careful with YAML content since its space sensitive.</p>
</li>
</ul>
<pre><code class="language-YAML">---
# vars file for jinja2_spine
  nxos_provider:
    username: &quot;{{ user }}&quot;
    password: &quot;{{ pwd }}&quot;
    timeout: 100
    host: &quot;{{ inventory_hostname }}&quot;
  asn: 65000
  bgp_neighbors:
  -  remote_as: 65000
     neighbor: 192.168.0.8
     update_source: Loopback0
  -  remote_as: 65000
     neighbor: 192.168.0.10
     update_source: Loopback0
  -  remote_as: 65000
     neighbor: 192.168.0.11
     update_source: Loopback0
  L3_interfaces:
  -  interface: Ethernet 1/1
  -  interface: Ethernet 1/2
  -  interface: Ethernet 1/3
  -  interface: Ethernet 1/4
  -  interface: loopback 0
  -  interface: loopback 1
  s1_loopback: 192.168.0.6
  s2_loopback: 192.168.0.7
</code></pre>
<ul>
<li>
<p>Contents of the ‘<strong>main.yml</strong>’ file should look like below:</p>
<p><img alt="" src="../pic/3-4-2.png" /></p>
</li>
<li>
<p><strong>Click</strong> <code>File</code> and <code>Save</code> . This will save the playbook, and also ftp the playbook to Ansible server using pre-configured “<strong>remote-sync</strong>” package. </p>
</li>
</ul>
<hr />
<h3 id="step-5-create-jinja2-template-for-spine-role">Step 5: Create Jinja2 template for spine role</h3>
<ul>
<li>On <strong>ATOM</strong> open up the project folder <code>LTRDCN-1572</code> from the left pane and <strong>open</strong> <code>spine.j2</code> file under “<strong>roles/jinja2_spine/templates</strong>” as shown below:</li>
</ul>
<p><img alt="" src="../pic/3-5-0.png" /></p>
<p><strong>NOTE: If the file does not appear on the ATOM, then go ahead and execute below 4 steps to get it sync.  If the <code>spine.j2</code> file appears in above folder then you can skip below 4 steps</strong>:</p>
<ol>
<li>On Ansible server (198.18.134.150) using your SSH session, change Directory to folder LTRDCN-1572 using below command:</li>
</ol>
<pre><code>[root@rhel7-tools ~]# cd ~/LTRDCN-1572 
</code></pre>
<ol>
<li>further, change Directory (cd) to folder roles/jinja2_spine/templates using below command: </li>
</ol>
<pre><code>[root@rhel7-tools LTRDCN-1572]# cd roles/jinja2_spine/templates
</code></pre>
<ol>
<li>Type <code>touch spine.j2</code> as shown below:</li>
</ol>
<pre><code>[root@rhel7-tools templates]# touch spine.j2
</code></pre>
<ol>
<li>After entering the command, go back to ATOM,  <strong>right click</strong> on folder <code>LTRDCN-1572</code>, scroll to choose option <code>Remote Sync</code> option and choose <code>Download Folder</code> as shown below: </li>
</ol>
<p><img alt="" src="../pic/3-5-1.png" /></p>
<p>Now that the file/folder appears properly on ATOM, go ahead and proceed with further steps:</p>
<ul>
<li>
<p>To reduce the typo, you can download jina2 template from the <strong>box</strong> folder spine.j2. Below is the link to this folder:</p>
<p><a href="http://cs.co/LTRDCN-1572">http://cs.co/LTRDCN-1572</a></p>
</li>
<li>
<p>The file would be under <code>LTRDCN-1572/roles/jinja2_spine/templates/spine.j2</code> (link below) as shown in below screenshot:</p>
<p><a href="https://cisco.app.box.com/folder/44981931157">https://cisco.app.box.com/folder/44981931157
</a></p>
<p><img alt="" src="../pic/3-5-2.png" /></p>
</li>
<li>
<p>After the file is downloaded to the PC (on your RDP session), go to the downloads folder. Move (or copy) the file from the downloads folder and paste the file in the projects folder</p>
<p><code>TFTP_Data (\\AD1) (X:)</code> --&gt;  <code>LTRDC-1572</code> --&gt; <code>roles</code> --&gt; <code>jinja2_spine</code> --&gt; <code>templates</code></p>
<p>as shown below:</p>
<p><img alt="" src="../pic/3-5-3.png" /></p>
</li>
<li>
<p>After moving/copying this file to above folder location, open this file on ATOM.  You do this by going to <code>File</code> then <code>Open File…</code> on ATOM, and browse to this <code>spine.j2</code> file that was just saved in <code>X:\LTRDCN-1572\roles\jinja2_spine\templates</code> as shown below:
    <img alt="" src="../pic/3-5-4.png" /></p>
</li>
<li>
<p>After opening “<strong>spine.j2</strong>” file from ATOM (as shown in below screenshot confirming the updated content), go to <code>File</code> –-&gt; <code>Save</code> to push template file to Ansible node:</p>
<p><img alt="" src="../pic/3-5-5.png" /></p>
</li>
<li>
<p>You can verify that updated file content is on Ansible server (198.18.134.150) using your SSH session by issuing below commands:</p>
</li>
</ul>
<pre><code>[root@rhel7-tools templates]# cd /root/LTRDCN-1572/roles/jinja2_spine/templates
[root@rhel7-tools templates]# more spine.j2
</code></pre>
<p>Partial output of above command is shown in below screenshot confirming :
  <img alt="" src="../pic/3-5-6.png" /></p>
<hr />
<h3 id="step-6-create-playbook-for-jinja2_spine-role">Step 6: Create playbook for jinja2_spine role</h3>
<p>The playbook for jinja2_spine roles has two tasks. First task uses ansible <strong>template</strong> module to generate configuration file based on jinja2 template created in last step. The configuration file is saved in “<strong>file</strong>” folder. Second task is push the configuration to switch. </p>
<p>“<strong>ansible-galaxy</strong>” automatically creates empty “<strong>main.yml</strong>” file under “<strong>tasks</strong>” folder.  We are going to use “<strong>Atom</strong>” to edit the <strong>main.yml</strong> file. </p>
<ul>
<li>On ATOM, open up the project folder <code>LTRDCN-1572</code> and edit <code>main.yml</code> file under <code>roles/jinja2_spine/tasks/</code> to include following: </li>
</ul>
<pre><code class="language-YAML">---
# tasks file for jinja2_spine
  - name: Generate Spine Config
    template: src=spine.j2 dest=roles/jinja2_spine/files/{{inventory_hostname}}.cfg
  - name: Push Spine Config
    nxos_config:
      src: roles/jinja2_spine/files/{{inventory_hostname}}.cfg
      match: none
      provider: &quot;{{ nxos_provider }}&quot;
</code></pre>
<ul>
<li>
<p>Contents of the ‘<strong>main.yml</strong>’ file should look like below:</p>
<p><img alt="" src="../pic/3-6-1.png" /></p>
</li>
<li>
<p><strong>Click</strong> <code>File</code> and <code>Save</code> . This will save the playbook, and also ftp the playbook to Ansible server using pre-configured “<strong>remote-sync</strong>” package. </p>
</li>
</ul>
<p><strong>NOTE:</strong> In the above YAML file, ansible module named “<strong>nxos_config</strong>” is used.  This module performs below activities:</p>
<ul>
<li>It uses source path of the file (“<strong><em>src</em></strong>”) that contains the configuration or configuration template to load into spine</li>
<li>Since “<strong><em>match</em></strong>” option is set to none (yes), hence the module will not attempt to compare the source configuration with the running configuration on the remote device.</li>
</ul>
<hr />
<h3 id="step-7-run-jinja2_fabric-playbook">Step 7: Run Jinja2_fabric playbook</h3>
<p>In this section you will run the playbook created in step 2 (in this task 3), this will generate configuration file for Spine-2 switche from the template. </p>
<p>The playbook will also push the configuration file to Spine-2 switches. </p>
<ul>
<li>
<p>Run the ansible playbook by going to folder LTRDC-1572 and executing the below commands:</p>
<pre><code>[root@rhel7-tools roles]# cd ~/LTRDCN-1572/
[root@rhel7-tools LTRDCN-1572]# ansible-playbook jinja2_fabric.yml
</code></pre>
<p><strong>Note: It will take few minutes to push configuration</strong></p>
<p>Below screenshot shows the execution of above playbook:</p>
<p><img alt="" src="../pic/3-7-1.png" /></p>
</li>
</ul>
<p>To verify the execution of this playbook, you can:</p>
<ul>
<li>
<p><strong>Login</strong> to <strong>Spine-2 </strong>switch (<strong>on MTputty</strong>) to verify configuration has been pushed by double clicking the spine-2 icon in the left pane on MTputty.  If prompted then login with credentials admin/C1sco12345</p>
</li>
<li>
<p>Execute <code>show run bgp</code> command on the switch to confirm the configurations have been provisioned (as shown below):</p>
<p><img alt="" src="../pic/3-7-2-new.png" /></p>
</li>
</ul>
<hr />
<h3 id="step-8-modify-playbook-for-leaf">Step 8: Modify playbook for Leaf</h3>
<p>In this section, we will use Jina2 template and Ansible to provision the VXLAN Fabric on leaf-4.   We are going to add jinja2_leaf this time to the already created playbook in step 2.</p>
<ul>
<li>Switch to “<strong>Atom</strong>”, click on the folder <code>LTRDDCN-1572</code>, edit the existing playbook <code>jinja2_fabric.yml</code> file for a role for leaf (named jinja2_leaf).  Add the below content at the end of existing file (i.e., add the below content to existing content in this file (do not overwrite existing content):</li>
</ul>
<pre><code class="language-YAML">- hosts: jinja2_leaf
  connection: local
  roles:
    - jinja2_leaf
</code></pre>
<ul>
<li>Below screenshot shows the contents of <strong>jinja2_fabric.yml</strong> file in Atom after adding the above configs:</li>
</ul>
<p><img alt="" src="../pic/3-8-1.png" /></p>
<ul>
<li><strong>Click</strong> <code>File</code> and <code>Save</code> . This will save the playbook, and also ftp the playbook to Ansible server using pre-configured “<strong>remote-sync</strong>” package. </li>
</ul>
<hr />
<h3 id="step-9-variable-file-for-jinja2_leaf-role">Step 9: Variable file for jinja2_leaf role</h3>
<ul>
<li>On ATOM, open up the project folder <code>LTRDCN-1572</code> and edit <code>main.yml</code> file under <code>roles/jinja2_leaf/vars/</code> to include following:</li>
</ul>
<pre><code class="language-YAML">---
# vars file for jinja2_leaf
  nxos_provider:
    username: &quot;{{ user }}&quot;
    password: &quot;{{ pwd }}&quot;
    timeout: 100
    host: &quot;{{ inventory_hostname }}&quot;
  asn: 65000
  bgp_neighbors:
  -  remote_as: 65000
     neighbor: 192.168.0.6
     update_source: Loopback0
  -  remote_as: 65000
     neighbor: 192.168.0.7
     update_source: Loopback0
  rp_address: 192.168.0.100
  L3_interfaces:
  -  interface: Ethernet 1/1
  -  interface: Ethernet 1/2
  -  interface: loopback 0
  -  interface: loopback 1
  L2VNI:
  -  vlan_id: 140
     vni: 50140
     ip_add: 172.21.140.1
     mask: 24
     vlan_name: L2-VNI-140-Tenant1
     mcast: 239.0.0.140
  -  vlan_id: 141
     vni: 50141
     ip_add: 172.21.141.1
     mask: 24
     vlan_name: L2-VNI-141-Tenant1
     mcast: 239.0.0.141
  L3VNI:
  -  vlan_id: 999
     vlan_name: L3-VNI-999-Tenant1
     vni: 50999
</code></pre>
<ul>
<li>
<p>Below screenshot shows the contents of jinja2_leaf\vars\main.yml file in Atom:</p>
<p><img alt="" src="../pic/3-9-1.png" /></p>
</li>
<li>
<p><strong>Click</strong> <code>File</code> and <code>Save</code> . This will save the playbook, and also ftp the playbook to Ansible server using pre-configured “<strong>remote-sync</strong>” package. </p>
</li>
</ul>
<hr />
<h3 id="step-10-jinja2-template-for-leaf-role">Step 10: Jinja2 template for leaf role</h3>
<ul>
<li>On ATOM, open up the project folder <code>LTRDCN-1572</code> and open <strong>leaf.j2</strong> file under “<strong>roles/jinja2_leaf/templates/</strong>”</li>
</ul>
<p><strong>NOTE: if the file does not appear on the ATOM, then go ahead and execute below 4 steps to get it sync.  If the <code>leaf.j2</code> file appears in above folder then you can skip below 4 steps</strong>:</p>
<ol>
<li>
<p>On MTputty, change Directory to folder LTRDCN-1572 on Ansible server (198.18.134.150) using below command:</p>
<pre><code>cd ~/LTRDC-1572
</code></pre>
</li>
<li>
<p>further, change Directory (cd) to folder roles/jinja2_leaf/templates using below command:</p>
<pre><code>cd roles/jinja2_leaf/templates
</code></pre>
</li>
<li>
<p>Type <code>touch leaf.j2</code></p>
</li>
<li>After entering the command, go back to ATOM,  <strong>right click</strong> on folder <code>LTRDCN-1572</code>, scroll to choose option <code>Remote Sync</code> option and choose <code>Download Folder</code></li>
</ol>
<p>Now that the file/folder appears properly on ATOM, go ahead and proceed with further steps:</p>
<ul>
<li>
<p>To reduce the typo, you can download jina2 template from the <strong>box</strong> folder leaf.j2. Below is the link to this folder:</p>
</li>
<li>
<p>To reduce the typo, you can download jina2 template from the <strong>box</strong> folder leaf.j2. Below is the link to this folder:</p>
<p><a href="http://cs.co/LTRDCN-1572">http://cs.co/LTRDCN-1572</a></p>
</li>
<li>
<p>The file would be under <code>LTRDCN-1572/roles/jinja2_leaf/templates/leaf.j2</code> (link below) as shown in below screenshot:</p>
<p><a href="https://cisco.app.box.com/folder/44981518497">https://cisco.app.box.com/folder/44981518497
</a></p>
<p><img alt="" src="../pic/3-10-1.png" /></p>
</li>
<li>
<p>After the file is downloaded to the PC (on your RDP session), go to the downloads folder. Move (or copy) the file from the downloads folder and paste the file in the projects folder</p>
<p><code>TFTP_Data (\\AD1) (X:)</code> --&gt;  <code>LTRDC-1572</code> --&gt; <code>roles</code> --&gt; <code>jinja2_leaf</code> --&gt; <code>templates</code></p>
<p>as shown below:</p>
<p><img alt="" src="../pic/3-10-2.png" /></p>
</li>
<li>
<p>On ATOM, go to <code>File</code> then <code>Open File…</code> and browse to this <code>leaf.j2</code> that was just saved in <code>X:\LTRDCN-1572\roles\jinja2_leaf\templates</code> as shown below screenshots:
    <img alt="" src="../pic/3-10-3.png" /></p>
<p><img alt="" src="../pic/3-10-4.png" /></p>
</li>
<li>
<p>After opening “<strong>leaf.j2</strong>” file from ATOM, go to <code>File</code> – <code>Save</code> to push template file to Ansible node:</p>
</li>
</ul>
<hr />
<h3 id="step-11-create-playbook-for-jinja2_leaf-role">Step 11: Create playbook for jinja2_leaf role</h3>
<p>The playbook for jinja2_leaf roles has two tasks. </p>
<ol>
<li>First task uses ansible template module to generate configuration file based on jinja2 template created in last step. The configuration file is saved in “file” folder. </li>
<li>Second task is to push the configuration to switch. </li>
</ol>
<p>“<strong>ansible-galaxy</strong>” automatically creates empty “<strong>main.yml</strong>” file under “<strong>tasks</strong>” folder.  We are going to use “<strong>Atom</strong>” to edit this main.yml file. </p>
<ul>
<li>On ATOM, open up the project folder <code>LTRDCN-1572</code> and edit “<strong>main.yml</strong>” file under “<strong>roles/jinja2_leaf/tasks/</strong>” to include following:</li>
</ul>
<pre><code class="language-YAML">---
# tasks file for jinja2_leaf
  - name: Generate Leaf Config
    template: src=leaf.j2 dest=roles/jinja2_leaf/files/{{inventory_hostname}}.cfg
  - name: Push Leaf Config
    nxos_config:
      src: roles/jinja2_leaf/files/{{inventory_hostname}}.cfg
      match: none
      provider: &quot;{{ nxos_provider }}&quot;
</code></pre>
<p>Below screenshot shows how the contents of <strong>jinja2_leaf/taks/main.yml</strong> file looks like in Atom:</p>
<p><img alt="" src="../pic/3-11-1.png" /></p>
<hr />
<h3 id="step-12-run-jinja2_fabric-playbook">Step 12: Run Jinja2_fabric playbook</h3>
<p>In this section you will run the playbook created in step 8, this will generate configuration file for Spine-2 and Leaf-4 switches. It will also push the configuration file to both switches. </p>
<ul>
<li>
<p>Before running the ansible-playbook, you may <strong>log</strong> into the leaf-4 (in MTputty SSH session) and verify that no bgp configurations exist by running <code>show running bgp</code> command as shown below:</p>
<p><img alt="" src="../pic/3-12-0.png" /></p>
</li>
</ul>
<p>NOTE: It might take couple of minutes for the configuration to be pushed to via the Ansible Server. It is working in the background. </p>
<ul>
<li>
<p>On the Ansible node (in MTputty SSH session), run the command (<code>ansible-playbook jinja2_fabric.yml</code>) to execute the playbook as shown below:</p>
<pre><code>[root@rhel7-tools LTRDCN-1572]# ansible-playbook jinja2_fabric.yml
</code></pre>
<p>Below screenshot shows the output of above command:</p>
<p><img alt="" src="../pic/3-12-1.png" /></p>
</li>
<li>
<p>After the configuration push is successful, <strong>login</strong> (on MTputty SSH session) to <strong>leaf-4</strong> switch to verify configuration has been pushed by running below command:</p>
<pre><code>show running-config bgp
</code></pre>
<p>The output of above command is shown below:</p>
<p><img alt="" src="../pic/3-12-2.png" /></p>
</li>
</ul>
<hr />
<p>Congrats: you have successfully concluded this task by using jinja2 templates with Ansible for Cisco Nexus switches</p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../task2-first-ansible/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Task 2 - First Simple Ansible Playbook" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Task 2 - First Simple Ansible Playbook
            </div>
          </div>
        </a>
      
      
        
        <a href="../task4-vxlan-nxos/" class="md-footer__link md-footer__link--next" aria-label="Next: Task 4 - Config switches using Ansible NXOS modules" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Task 4 - Config switches using Ansible NXOS modules
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        
          Made with
          <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
            Material for MkDocs
          </a>
        
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.fcfe8b6d.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.b1047164.min.js"></script>
      
    
  </body>
</html>