<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Task 5 - Day 2 Operations - Cisco Live 2021 HOLDCN-1010</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Task 5 - Day 2 Operations";
    var mkdocs_page_input_path = "task5-day2-operation.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Cisco Live 2021 HOLDCN-1010</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../intro/">Introduction</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../Task1-ansible-node/">Task 1 - Prepare Ansible node</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../task2-first-ansible/">Task 2 - First Simple Ansible Playbook</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../task3-vxlan-jinja2/">Task 3 - Use of Jinja2 templates with Ansible Playbook</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../task4-vxlan-nxos/">Task 4 - Config switches using Ansible NXOS modules</a>
                    </li>
                </ul>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Task 5 - Day 2 Operations</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#step-1-backup-running-configurations">Step 1: Backup running configurations</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#step-2-verify-underlay-and-overlay">Step 2: Verify underlay and overlay</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#step-3-baseline-configuration-comparison">Step 3: Baseline configuration comparison</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#step-4-add-new-vni">Step 4: Add new VNI</a>
    </li>
    </ul>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../appendixA-F5/">Appendix A - F5</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../appendixB-Upgrade/">Appendix B - Upgrade</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Cisco Live 2021 HOLDCN-1010</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Task 5 - Day 2 Operations</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/fchaudhr/holdcn-1010.git/edit/master/docs/task5-day2-operation.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>

          <div role="main">
            <div class="section">
              
                <h1 id="task-5-day-2-operation-using-ansible">Task 5: Day 2 operation using Ansible</h1>
<p>In this section, we will use automation to perform following day 2 operation tasks. </p>
<ul>
<li>Backup running configurations on all leaf and spine switches </li>
<li>Verify underlay ospf, bgp and pim neighbors </li>
<li>Verify overlay nve peer, host route, bgp update </li>
<li>Baseline configuration comparison </li>
<li>Add new VNIs into the existing fabric</li>
</ul>
<hr />
<h3 id="step-1-backup-running-configurations">Step 1: Backup running configurations</h3>
<p>In this section, you will use <strong>ios_config</strong> module to backup running configuration on each switch, the backup file will be saved to a local <strong>“backup”</strong> folder.  The backup argument create a full backup of the current running-config of each switch.  The backup file is written to the backup folder in the playbook root directory. If the directory does not exist, it is created.</p>
<ul>
<li>
<p>On <strong>Atom</strong>, open up the project folder <strong>“LTRDCN-1572”</strong> and create new file under <code>LTRDCN-1572</code>. Name the new file <code>get_config.yml</code>.</p>
</li>
<li>
<p><strong>Click</strong> <code>File</code> and <code>Save</code> . This will save the playbook, and also ftp the playbook to Ansible server using pre-configured “<strong>remote-sync</strong>” package. </p>
</li>
</ul>
<pre><code class="language-YAML">---
  - hosts: spine,leaf,jinja2_leaf,jinja2_spine
    connection: local
    vars:
      ios_provider:
        transport: nxapi
        username: &quot;{{ user }}&quot;
        password: &quot;{{ pwd }}&quot;
        host: &quot;{{ inventory_hostname }}&quot;
    tasks:
      - name: save running
        nxos_config:
           provider: &quot;{{ ios_provider }}&quot;
           backup: yes
           timeout: 20

</code></pre>
<ul>
<li>
<p>On the Ansible node (using MTputty via SSH), run <strong>“get_config.yml”</strong> playbook and verify the backup configurations in <strong>“backup”</strong> folder by using below commands:</p>
<pre><code>[root@rhel7-tools LTRDCN-1572]# ansible-playbook get_config.yml
[root@rhel7-tools LTRDCN-1572]# ls -lrt
[root@rhel7-tools LTRDCN-1572]# ls backup
</code></pre>
<p>You may further view the contents of the files under backup folder by using cat, less or more commands.  Below screenshot shows the output of above commands</p>
<p><img alt="" src="../pic/5-1-1.png" /></p>
</li>
</ul>
<hr />
<h3 id="step-2-verify-underlay-and-overlay">Step 2: Verify underlay and overlay</h3>
<p>In this step, you will verify underlay and overlay operation using ansible playbook. The playbook will be applied to all leaf switches to verify the below commands:</p>
<p><strong><em>Underlay</em></strong> </p>
<pre><code>-   show ip ospf neighbor
-   show ip bgp sum
-   show ip pim neighbor
</code></pre>
<p><strong><em>Overlay</em></strong></p>
<pre><code>-   show nve vni
-   show nve peer
-   show ip route vrf Tenant-1
-   show bgp l2vpn evpn
-   show l2route evpn mac-ip all
</code></pre>
<ul>
<li>Switch to “Atom”, <strong>right click</strong> on the folder <code>LTRDDCN-1572</code> and create a new playbook named <code>verify_fabric.yml</code>. Enter this file name and hit enter.</li>
</ul>
<pre><code class="language-YAML">---
  - hosts: leaf, jinja2_leaf
    connection: local
    gather_facts: false
    vars:
      ios_provider:
         username: &quot;{{ user }}&quot;
         password: &quot;{{ pwd }}&quot;
         timeout: 30
         host: &quot;{{ inventory_hostname }}&quot;
    tasks:
      - name: verify underlay
        register: underlay_output
        ios_command:
          provider: &quot;{{ ios_provider }}&quot;
          commands:
            - show ip ospf neighbors
            - show ip bgp sum
            - show ip pim neighbor
        tags: underlay
      - debug: var=underlay_output.stdout_lines
        tags: underlay
#      - copy: content=&quot;{{underlay_output | to_nice_json}}&quot; dest=&quot;verify/{{inventory_hostname}}_underlay&quot;
      - name: Verify Overlay
        register: overlay_output
        ios_command:
          provider: &quot;{{ ios_provider }}&quot;
          commands:
            - show nve vni
            - show nve peer
            - show ip route vrf Tenant-1
            - show bgp l2vpn evpn
            - show l2route evpn mac-ip all
        tags: overlay
      - debug: var=overlay_output.stdout_lines
        tags: overlay
</code></pre>
<ul>
<li>
<p><strong>Click</strong> <code>File</code> and <code>Save</code> . This will save the playbook, and also ftp the playbook to Ansible server using pre-configured “<strong>remote-sync</strong>” package. </p>
</li>
<li>
<p>On the Ansible node (via MTPutty), run <strong>verify_fabric.yml</strong> playbook and verify the output for <strong>underlay</strong> by executing below command (using respective tag): </p>
</li>
</ul>
<pre><code>[root@rhel7-tools LTRDCN-1572]# ansible-playbook verify_fabric.yml --tags &quot;underlay&quot;
</code></pre>
<hr />
<p><font style=background-color:yellow>The output shows ospf, bgp and pim neighbors for all leaf switches</font></p>
<hr />
<ul>
<li>
<p>Below screenshot shows the partial output of above command:</p>
<p><img alt="" src="../pic/5-2-1.png" /></p>
</li>
</ul>
<p>Here is a log of execution of above command:</p>
<pre><code> [root@rhel7-tools LTRDCN-1572]# ansible-playbook verify_fabric.yml --tags &quot;underlay&quot;

PLAY [leaf, jinja2_leaf] ************************************************************************************************************************************************

TASK [verify underlay] **************************************************************************************************************************************************
 [WARNING]: argument username has been deprecated and will be removed in a future version

 [WARNING]: argument timeout has been deprecated and will be removed in a future version

 [WARNING]: argument password has been deprecated and will be removed in a future version

ok: [198.18.4.101]
ok: [198.18.4.104]
ok: [198.18.4.103]

TASK [debug] ************************************************************************************************************************************************************
ok: [198.18.4.101] =&gt; {
    &quot;underlay_output.stdout_lines&quot;: [
        [
            &quot;OSPF Process ID 1 VRF default&quot;,
            &quot; Total number of neighbors: 2&quot;,
            &quot; Neighbor ID     Pri State            Up Time  Address         Interface&quot;,
            &quot; 192.168.0.6       1 FULL/ -          1d03h    10.0.0.21       Eth1/1 &quot;,
            &quot; 192.168.0.7       1 FULL/ -          1d03h    10.0.128.5      Eth1/2&quot;
        ],
        [
            &quot;BGP summary information for VRF default, address family IPv4 Unicast&quot;,
            &quot;BGP router identifier 192.168.0.8, local AS number 65000&quot;,
            &quot;BGP table version is 8, IPv4 Unicast config peers 2, capable peers 2&quot;,
            &quot;0 network entries and 0 paths using 0 bytes of memory&quot;,
            &quot;BGP attribute entries [0/0], BGP AS path entries [0/0]&quot;,
            &quot;BGP community entries [0/0], BGP clusterlist entries [0/0]&quot;,
            &quot;&quot;,
            &quot;Neighbor        V    AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd&quot;,
            &quot;192.168.0.6     4 65000      52      54        8    0    0 00:24:18 0         &quot;,
            &quot;192.168.0.7     4 65000      47      49        8    0    0 00:30:45 0&quot;
        ],
        [
            &quot;PIM Neighbor Status for VRF \&quot;default\&quot;&quot;,
            &quot;Neighbor        Interface            Uptime    Expires   DR       Bidir-  BFD&quot;,
            &quot;                                                         Priority Capable State&quot;,
            &quot;10.0.0.21       Ethernet1/1          00:15:51  00:01:43  1        yes     n/a&quot;,
            &quot;10.0.128.5      Ethernet1/2          00:15:45  00:01:23  1        yes     n/a&quot;
        ]
    ]
}
ok: [198.18.4.104] =&gt; {
    &quot;underlay_output.stdout_lines&quot;: [
        [
            &quot;OSPF Process ID 1 VRF default&quot;,
            &quot; Total number of neighbors: 2&quot;,
            &quot; Neighbor ID     Pri State            Up Time  Address         Interface&quot;,
            &quot; 192.168.0.6       1 FULL/ -          10:20:18 10.0.128.1      Eth1/1 &quot;,
            &quot; 192.168.0.7       1 FULL/ -          10:20:15 10.0.128.17     Eth1/2&quot;
        ],
        [
            &quot;BGP summary information for VRF default, address family IPv4 Unicast&quot;,
            &quot;BGP router identifier 192.168.0.11, local AS number 65000&quot;,
            &quot;BGP table version is 4, IPv4 Unicast config peers 2, capable peers 2&quot;,
            &quot;0 network entries and 0 paths using 0 bytes of memory&quot;,
            &quot;BGP attribute entries [0/0], BGP AS path entries [0/0]&quot;,
            &quot;BGP community entries [0/0], BGP clusterlist entries [0/0]&quot;,
            &quot;&quot;,
            &quot;Neighbor        V    AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd&quot;,
            &quot;192.168.0.6     4 65000      32      32        4    0    0 00:24:03 0         &quot;,
            &quot;192.168.0.7     4 65000      34      34        4    0    0 00:25:16 0&quot;
        ],
        [
            &quot;PIM Neighbor Status for VRF \&quot;default\&quot;&quot;,
            &quot;Neighbor        Interface            Uptime    Expires   DR       Bidir-  BFD&quot;,
            &quot;                                                         Priority Capable State&quot;,
            &quot;10.0.128.1      Ethernet1/1          00:19:15  00:01:31  1        yes     n/a&quot;,
            &quot;10.0.128.17     Ethernet1/2          00:25:43  00:01:18  1        yes     n/a&quot;
        ]
    ]
}
ok: [198.18.4.103] =&gt; {
    &quot;underlay_output.stdout_lines&quot;: [
        [
            &quot;OSPF Process ID 1 VRF default&quot;,
            &quot; Total number of neighbors: 2&quot;,
            &quot; Neighbor ID     Pri State            Up Time  Address         Interface&quot;,
            &quot; 192.168.0.6       1 FULL/ -          1d03h    10.0.0.29       Eth1/1 &quot;,
            &quot; 192.168.0.7       1 FULL/ -          1d03h    10.0.128.13     Eth1/2&quot;
        ],
        [
            &quot;BGP summary information for VRF default, address family IPv4 Unicast&quot;,
            &quot;BGP router identifier 192.168.0.10, local AS number 65000&quot;,
            &quot;BGP table version is 8, IPv4 Unicast config peers 2, capable peers 2&quot;,
            &quot;0 network entries and 0 paths using 0 bytes of memory&quot;,
            &quot;BGP attribute entries [0/0], BGP AS path entries [0/0]&quot;,
            &quot;BGP community entries [0/0], BGP clusterlist entries [0/0]&quot;,
            &quot;&quot;,
            &quot;Neighbor        V    AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd&quot;,
            &quot;192.168.0.6     4 65000      52      53        8    0    0 00:24:19 0         &quot;,
            &quot;192.168.0.7     4 65000      47      49        8    0    0 00:30:47 0&quot;
        ],
        [
            &quot;PIM Neighbor Status for VRF \&quot;default\&quot;&quot;,
            &quot;Neighbor        Interface            Uptime    Expires   DR       Bidir-  BFD&quot;,
            &quot;                                                         Priority Capable State&quot;,
            &quot;10.0.0.29       Ethernet1/1          00:15:53  00:01:23  1        yes     n/a&quot;,
            &quot;10.0.128.13     Ethernet1/2          00:15:47  00:01:37  1        yes     n/a&quot;
        ]
    ]
}

PLAY RECAP **************************************************************************************************************************************************************
198.18.4.101               : ok=2    changed=0    unreachable=0    failed=0
198.18.4.103               : ok=2    changed=0    unreachable=0    failed=0
198.18.4.104               : ok=2    changed=0    unreachable=0    failed=0
</code></pre>
<p>Next:</p>
<ul>
<li>Run <strong>verify_fabric.yml</strong> playbook and verify the output for <strong>overlay</strong> using the respective tag in the command (as shown below):</li>
</ul>
<pre><code>[root@rhel7-tools LTRDCN-1572]# ansible-playbook verify_fabric.yml --tags &quot;overlay&quot;
</code></pre>
<hr />
<p><font style=background-color:yellow>The output shows nve tunnel peer, host route in bgp EVPN from all leaf switches</font></p>
<hr />
<ul>
<li>
<p>Below screenshot of the partial output of above command:</p>
<p><img alt="" src="../pic/5-2-2.png" /></p>
</li>
<li>
<p>Below shows the complete log output of execution of above playbook command.   Verify the output for <strong>vne vni</strong> status, <strong>vne</strong> dynamic neighbors, type host <strong>mac+ip evpn route update for each L2VNI, l2fib</strong> information.</p>
</li>
</ul>
<pre><code>[root@rhel7-tools LTRDCN-1572]# ansible-playbook verify_fabric.yml --tags &quot;overlay&quot;

PLAY [leaf, jinja2_leaf] **********************************************************************************************************************************************

TASK [Verify Overlay] *************************************************************************************************************************************************
 [WARNING]: argument username has been deprecated and will be removed in a future version

 [WARNING]: argument timeout has been deprecated and will be removed in a future version

 [WARNING]: argument password has been deprecated and will be removed in a future version

ok: [198.18.4.101]
ok: [198.18.4.104]
ok: [198.18.4.103]

TASK [debug] **********************************************************************************************************************************************************
ok: [198.18.4.101] =&gt; {
    &quot;overlay_output.stdout_lines&quot;: [
        [
            &quot;Codes: CP - Control Plane        DP - Data Plane          &quot;,
            &quot;       UC - Unconfigured         SA - Suppress ARP        &quot;,
            &quot;       SU - Suppress Unknown Unicast&quot;,
            &quot; &quot;,
            &quot;Interface VNI      Multicast-group   State Mode Type [BD/VRF]      Flags&quot;,
            &quot;--------- -------- ----------------- ----- ---- ------------------ -----&quot;,
            &quot;nve1      50140    239.0.0.140       Up    CP   L2 [140]                  &quot;,
            &quot;nve1      50141    239.0.0.141       Up    CP   L2 [141]                  &quot;,
            &quot;nve1      50999    n/a               Up    CP   L3 [Tenant-1]&quot;
        ],
        [
            &quot;Interface Peer-IP          State LearnType Uptime   Router-Mac       &quot;,
            &quot;--------- ---------------  ----- --------- -------- -----------------&quot;,
            &quot;nve1      192.168.0.110    Up    CP        00:03:19 000c.2939.f53f   &quot;,
            &quot;nve1      192.168.0.111    Up    CP        00:01:12 000c.2951.176f&quot;
        ],
        [
            &quot;IP Route Table for VRF \&quot;Tenant-1\&quot;&quot;,
            &quot;'*' denotes best ucast next-hop&quot;,
            &quot;'**' denotes best mcast next-hop&quot;,
            &quot;'[x/y]' denotes [preference/metric]&quot;,
            &quot;'%&lt;string&gt;' in via output denotes VRF &lt;string&gt;&quot;,
            &quot;&quot;,
            &quot;172.21.140.0/24, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.140.1, Vlan140, [0/0], 00:05:39, direct&quot;,
            &quot;172.21.140.1/32, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.140.1, Vlan140, [0/0], 00:05:39, local&quot;,
            &quot;172.21.140.10/32, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.140.10, Vlan140, [190/0], 00:05:33, hmm&quot;,
            &quot;172.21.140.11/32, ubest/mbest: 1/0&quot;,
            &quot;    *via 192.168.0.110%default, [200/0], 00:01:50, bgp-65000, internal, tag 65000 (evpn) segid: 50999 tunnelid: 0xc0a8006e encap: VXLAN&quot;,
            &quot; &quot;,
            &quot;172.21.141.0/24, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.141.1, Vlan141, [0/0], 00:05:38, direct&quot;,
            &quot;172.21.141.1/32, ubest/mbest: 1/0, attached&quot;,
            &quot;    *via 172.21.141.1, Vlan141, [0/0], 00:05:38, local&quot;,
            &quot;172.21.141.11/32, ubest/mbest: 1/0&quot;,
            &quot;    *via 192.168.0.111%default, [200/0], 00:01:12, bgp-65000, internal, tag 65000 (evpn) segid: 50999 tunnelid: 0xc0a8006f encap: VXLAN&quot;
        ],
        [
            &quot;BGP routing table information for VRF default, address family L2VPN EVPN&quot;,
            &quot;BGP table version is 35, Local Router ID is 192.168.0.8&quot;,
            &quot;Status: s-suppressed, x-deleted, S-stale, d-dampened, h-history, *-valid, &gt;-best&quot;,
            &quot;Path type: i-internal, e-external, c-confed, l-local, a-aggregate, r-redist, I-injected&quot;,
            &quot;Origin codes: i - IGP, e - EGP, ? - incomplete, | - multipath, &amp; - backup&quot;,
            &quot;&quot;,
            &quot;   Network            Next Hop            Metric     LocPrf     Weight Path&quot;,
            &quot;Route Distinguisher: 192.168.0.8:32907    (L2VNI 50140)&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[0050.56a0.b5d1]:[0]:[0.0.0.0]/216&quot;,
            &quot;                      192.168.0.110                     100          0 i&quot;,
            &quot;*&gt;l[2]:[0]:[0]:[48]:[0050.56a0.7630]:[32]:[172.21.140.10]/272&quot;,
            &quot;                      192.168.0.18                      100      32768 i&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[0050.56a0.b5d1]:[32]:[172.21.140.11]/272&quot;,
            &quot;                      192.168.0.110                     100          0 i&quot;,
            &quot;&quot;,
            &quot;Route Distinguisher: 192.168.0.8:32908    (L2VNI 50141)&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[000c.2979.f00d]:[0]:[0.0.0.0]/216&quot;,
            &quot;                      192.168.0.111                     100          0 i&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[000c.2979.f00d]:[32]:[172.21.141.11]/272&quot;,
            &quot;                      192.168.0.111                     100          0 i&quot;,
            &quot;&quot;,
            &quot;Route Distinguisher: 192.168.0.10:32907&quot;,
            &quot;* i[2]:[0]:[0]:[48]:[0050.56a0.b5d1]:[0]:[0.0.0.0]/216&quot;,
            &quot;                      192.168.0.110                     100          0 i&quot;,
            &quot;*&gt;i                   192.168.0.110                     100          0 i&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[0050.56a0.b5d1]:[32]:[172.21.140.11]/272&quot;,
            &quot;                      192.168.0.110                     100          0 i&quot;,
            &quot;* i                   192.168.0.110                     100          0 i&quot;,
            &quot;&quot;,
            &quot;Route Distinguisher: 192.168.0.11:32908&quot;,
            &quot;* i[2]:[0]:[0]:[48]:[000c.2979.f00d]:[0]:[0.0.0.0]/216&quot;,
            &quot;                      192.168.0.111                     100          0 i&quot;,
            &quot;*&gt;i                   192.168.0.111                     100          0 i&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[000c.2979.f00d]:[32]:[172.21.141.11]/272&quot;,
            &quot;                      192.168.0.111                     100          0 i&quot;,
            &quot;* i                   192.168.0.111                     100          0 i&quot;,
            &quot;&quot;,
            &quot;Route Distinguisher: 192.168.0.8:3    (L3VNI 50999)&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[000c.2979.f00d]:[32]:[172.21.141.11]/272&quot;,
            &quot;                      192.168.0.111                     100          0 i&quot;,
            &quot;*&gt;i[2]:[0]:[0]:[48]:[0050.56a0.b5d1]:[32]:[172.21.140.11]/272&quot;,
            &quot;                      192.168.0.110                     100          0 i&quot;
        ],
        [
            &quot;Flags -(Rmac):Router MAC (Stt):Static (L):Local (R):Remote (V):vPC link &quot;,
            &quot;(Dup):Duplicate (Spl):Split (Rcv):Recv(D):Del Pending (S):Stale (C):Clear&quot;,
            &quot;(Ps):Peer Sync (Ro):Re-Originated &quot;,
            &quot;Topology    Mac Address    Prod   Flags         Seq No     Host IP         Next-Hops      &quot;,
            &quot;----------- -------------- ------ ---------- --------------- ---------------&quot;,
            &quot;140         0050.56a0.7630 HMM    --            0          172.21.140.10  Local          &quot;,
            &quot;140         0050.56a0.b5d1 BGP    --            0          172.21.140.11  192.168.0.110  &quot;,
            &quot;141         000c.2979.f00d BGP    --            1          172.21.141.11  192.168.0.111&quot;
        ]
    ]
}
</code></pre>
<hr />
<h3 id="step-3-baseline-configuration-comparison">Step 3: Baseline configuration comparison</h3>
<p>In this section we will compare the running configuration with baseline configuration for configuration compliance check. The configuration file that we backed in tak 1 will be used as baseline configuration. </p>
<p>In this playbook, you will use <strong>“lookup”</strong> module to find the backup filename generated in Step 1. Then you will use <strong>diff_against</strong> function in <strong>nxos_config</strong> module to compare running configuration. </p>
<ul>
<li>On Atom, Open up the project folder <code>LTRDCN-1572</code> and create new file under <strong>“LTRDCN-1572”</strong>. Name the new file <code>verify_config.yml</code> and enter below data in this playbook:</li>
</ul>
<pre><code class="language-YAML">---
   - hosts: jinja2_leaf,leaf,jinja2_spine,spine
     connection: local
     gather_facts: flase
     vars:
       nxos_provider:
          transport: nxapi
          username: &quot;{{ user }}&quot;
          password: &quot;{{ pwd }}&quot;
          timeout: 30
          host: &quot;{{ inventory_hostname }}&quot;
       filename: &quot;{{ lookup('pipe', 'ls backup/{{ inventory_hostname}}_config.*')}}&quot;
     tasks:
       - name: configure compliance
         register: diff_config
#         when: (inventory_hostname in groups['leaf']) or (inventory_hostname in groups['jinja2_leaf'])
         nxos_config:
           provider: &quot;{{ nxos_provider }}&quot;
           diff_against: intended
           intended_config: &quot;{{ lookup('file', '{{filename}}') }}&quot;
</code></pre>
<ul>
<li>
<p><strong>Click</strong> <code>File</code> and <code>Save</code> . This will save the playbook, and also ftp the playbook to Ansible server using pre-configured “<strong>remote-sync</strong>” package. </p>
</li>
<li>
<p><strong>Before</strong> you run this playbook, <strong>SSH</strong> into <strong>leaf-4</strong> to make some configuration changes by issuing below commands:</p>
</li>
</ul>
<pre><code>config t
no router bgp 65000
copy run start
end
</code></pre>
<pre><code>Here is a log of execution of above command:
</code></pre>
<pre><code>Leaf-4# conf t
Enter configuration commands, one per line. End with CNTL/Z.
Leaf-4(config)# no router bgp 65000
Leaf-4(config)# copy run start
[########################################] 100%
Leaf-4(config)# end
Leaf-4#
</code></pre>
<ul>
<li>On the Ansible server (via MTputty SSH session), run the playbook for configuration compliance check by executing <code>ansible-playbook --diff verify_config.yml</code> as shown below below:</li>
</ul>
<pre><code>[root@rhel7-tools LTRDCN-1572]# ansible-playbook --diff verify_config.yml
</code></pre>
<hr />
<p><font style=background-color:yellow>The delta between current running config and base line config are highlighted in <font style=color:limegreen>RED</font> from the result</font></p>
<hr />
<ul>
<li>
<p>Below partial screenshot shows the output of above command:</p>
<p><img alt="" src="../pic/5-3-1.png" /></p>
</li>
<li>
<p>Bring leaf-4 back to the baseline config by executing <code>ansible-playbook jinja2_fabric.yml --limit=198.18.4.104</code> command as shown below:</p>
</li>
</ul>
<pre><code>[root@rhel7-tools LTRDCN-1572]# ansible-playbook jinja2_fabric.yml --limit=198.18.4.104
</code></pre>
<ul>
<li>
<p>Below screenshot shows the output of above command.  You can also log into leaf-4 and verify that bgp configurations are back:</p>
<p><img alt="" src="../pic/5-3-2.png" /></p>
</li>
</ul>
<hr />
<h3 id="step-4-add-new-vni">Step 4: Add new VNI</h3>
<p>In this section, we will introduce following new VNI into the VXLAN fabric. </p>
<table>
<thead>
<tr>
<th>VLAN ID</th>
<th>VLAN Name</th>
<th>VNI</th>
<th>IP_Add</th>
<th>mask</th>
<th>Mcast</th>
</tr>
</thead>
<tbody>
<tr>
<td>200</td>
<td>L2-VNI-200-Tenant1</td>
<td>50200</td>
<td>172.21.200.1</td>
<td>24</td>
<td>239.0.0.200</td>
</tr>
<tr>
<td>201</td>
<td>L2-VNI-201-Tenant1</td>
<td>50201</td>
<td>172.21.201.1</td>
<td>24</td>
<td>239.0.0.201</td>
</tr>
</tbody>
</table>
<ul>
<li>First we will creat a new role, and name it <strong>“vni_provision”</strong> under folder roles using <strong>ansible-galaxy</strong> using below commands on the Ansible node (using MTputty via SSH connection): </li>
</ul>
<pre><code>[root@rhel7-tools LTRDCN-1572]# cd roles/
[root@rhel7-tools roles]# ansible-galaxy init vni_provision
</code></pre>
<ul>
<li>
<p>Verify vni_provision was created successfully</p>
</li>
<li>
<p>Ansible-galaxy init will create new role with base role structure and empty <strong>main.yml</strong> file as role requires.  </p>
</li>
<li>
<p>Switch to <strong>“Atom”</strong> and sync the new created folders between Ansible node and remote desktop. Right click on project folder <strong>“LTRDCN-1572”</strong>, open <strong>“Remote Sync”</strong> select <strong>“Download Folder”</strong></p>
<p><img alt="" src="../pic/5-4-1.png" /></p>
</li>
<li>
<p>Edit variable file <strong>main.yml</strong> for <strong>“vni_provision”</strong> role under “<strong>/root/LTRDCN-1572/roles/vni_provision/vars</strong>” and enter below data.  Make sure to click <code>File</code> and <code>Save</code> on Atom to push this to Ansible server:</p>
</li>
</ul>
<pre><code class="language-YAML">---
# vars file for vni_provision
  nxos_provider:
    username: &quot;{{ user }}&quot;
    password: &quot;{{ pwd }}&quot;
    transport: nxapi
    timeout: 30
    host: &quot;{{ inventory_hostname }}&quot;

  L2VNI:
  - { vlan_id: 200, vni: 50200, ip_add: 172.21.200.1, mask: 24, vlan_name: L2-VNI-200-Tenant1, mcast: 239.0.0.200 }
  - { vlan_id: 201, vni: 50201, ip_add: 172.21.201.1, mask: 24, vlan_name: L2-VNI-201-Tenant1, mcast: 239.0.0.201 }
</code></pre>
<p><img alt="" src="../pic/5-4-2.png" /></p>
<ul>
<li>Edit playbook file <strong>main.yml</strong> for <strong>“vni_provision”</strong> role under <strong>“/root/LTRDCN-1572/roles/vni_provision/tasks”</strong> and enter below data.   Make sure to click <code>File</code> and <code>Save</code> on Atom to push this to Ansible server:</li>
</ul>
<pre><code class="language-YAML">---
# tasks file for vni_provision
       - name: Configure VLAN to VNI
         nxos_vlan:
           vlan_id: &quot;{{ item.vlan_id }}&quot;
           mapped_vni: &quot;{{ item.vni }}&quot;
           name: &quot;{{ item.vlan_name }}&quot;
           provider: &quot;{{ nxos_provider }}&quot;
         with_items:
         - &quot;{{ L2VNI }}&quot;
       - name: Configure L2VNI
         nxos_interface:
           interface: vlan&quot;{{ item.vlan_id }}&quot;
           provider: &quot;{{ nxos_provider }}&quot;
         with_items: &quot;{{ L2VNI }}&quot;
       - name: Assign interface to Tenant VRF
         nxos_vrf_interface:
           vrf: Tenant-1
           interface: &quot;vlan{{ item.vlan_id }}&quot;
           provider: &quot;{{ nxos_provider }}&quot;
         with_items:
         - &quot;{{ L2VNI }}&quot;
       - name: Configure SVI IP
         nxos_ip_interface:
           interface: &quot;vlan{{ item.vlan_id }}&quot;
           addr: &quot;{{ item.ip_add }}&quot;
           mask: &quot;{{ item.mask }}&quot;
           provider: &quot;{{ nxos_provider }}&quot;
         with_items: &quot;{{ L2VNI }}&quot;
       - name: Configure L2VNI SVI
         nxos_interface:
           interface: vlan&quot;{{ item.vlan_id }}&quot;
           fabric_forwarding_anycast_gateway: true
           provider: &quot;{{ nxos_provider }}&quot;
         with_items: &quot;{{ L2VNI }}&quot;
       - name: Configure L2VNI to VTEP
         nxos_vxlan_vtep_vni:
            interface: nve1
            vni: &quot;{{ item.vni }}&quot;
            multicast_group: &quot;{{ item.mcast }}&quot;
            provider: &quot;{{ nxos_provider }}&quot;
         with_items: &quot;{{ L2VNI }}&quot;
       - name: Configure L2VNI RD/RT
         nxos_evpn_vni:
          vni: &quot;{{ item.vni }}&quot;
          route_distinguisher: auto
          route_target_both: auto
          provider: &quot;{{ nxos_provider }}&quot;
         with_items: &quot;{{ L2VNI }}&quot;
</code></pre>
<p>this is shown in below screenshot:</p>
<p><img alt="" src="../pic/5-4-3.png" /></p>
<ul>
<li>Switch to “Atom”  create new playbook <strong>‘vni_provision.yml’</strong> under project folder <strong>LTRDCN-1572</strong> and enter below data.  Make sure to click <code>File</code> and <code>Save</code> on Atom to push this to Ansible server:</li>
</ul>
<pre><code class="language-YAML">---
- hosts: leaf,jinja2_leaf
  connection: local
  roles:
    - vni_provision
</code></pre>
<ul>
<li>Run playbook <strong>vni_provision.yml</strong> to add new VNIs on the fabric by issuing <code>ansible-playbook vni_provision.yml</code> command as shown below:</li>
</ul>
<pre><code>[root@rhel7-tools LTRDCN-1572]# ansible-playbook vni_provision.yml
</code></pre>
<p>Below screenshot shows the output of above command:</p>
<p><img alt="" src="../pic/5-4-4.png" /></p>
<ul>
<li>Switch to <strong>MTPutty</strong> and connect to <strong>leaf-4</strong> (SSH connection0, verify the change on leaf switches by issuing below command:</li>
</ul>
<pre><code>show nve vni
</code></pre>
<p>Notice the new created L2VNI as shown in below screenshot:</p>
<p><img alt="" src="../pic/5-4-5-new.png" /></p>
<h1 id="congratulation-you-have-completed-vxlan-fabric-lab">Congratulation! You have completed VXLAN Fabric Lab.</h1>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../appendixA-F5/" class="btn btn-neutral float-right" title="Appendix A - F5">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../task4-vxlan-nxos/" class="btn btn-neutral" title="Task 4 - Config switches using Ansible NXOS modules"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/fchaudhr/holdcn-1010.git/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../task4-vxlan-nxos/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../appendixA-F5/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
